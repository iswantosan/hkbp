  import 'package:flutter/material.dart';
    import 'package:http/http.dart' as http;
    import 'dart:convert';
    
    class BiblePage extends StatefulWidget {
    const BiblePage({super.key});
    
    @override
    State<BiblePage> createState() => _BiblePageState();
  }
    
    class _BiblePageState extends State<BiblePage> {
    List<dynamic> _books = [];
    bool _isLoading = true;
    String _errorMessage = "";
    
    // Base URL dari file api-1.yaml
    final String baseUrl = "https://versete-biblice.ro/api/v1";
    
    @override
    void initState() {
    super.initState();
    _fetchBibleData();
    }
    
    Future<void> _fetchBibleData() async {
    setState(() {
    _isLoading = true;
    _errorMessage = "";
    });

    try {
  // Endpoint sesuai YAML: /api/v1/bible/translations
    // Kita tambahkan query language=en agar data yang muncul lebih universal
    final response = await http.get(
    Uri.parse('$baseUrl/bible/translations?language=en'),
  headers: {"Accept": "application/json"},
  ).timeout(const Duration(seconds: 15));
    
    if (response.statusCode == 200) {
    final Map<String, dynamic> decodedData = json.decode(response.body);
    
    setState(() {
  // Sesuai YAML: Properti 'success' (boolean) dan 'translations' (array)
    if (decodedData['success'] == true && decodedData['translations'] != null) {
    List translations = decodedData['translations'];
    
    if (translations.isNotEmpty) {
    // Mengambil daftar kitab dari translasi pertama yang tersedia
  // Sesuai YAML: Objek translation memiliki properti 'books'
    _books = translations[0]['books'] ?? [];
  } else {
    _errorMessage = "Tidak ada translasi yang ditemukan.";
  }
  } else {
    _errorMessage = "Gagal memproses data Alkitab.";
  }
    _isLoading = false;
  });
  } else {
    setState(() {
    _isLoading = false;
  _errorMessage = "Server Error: ${response.statusCode}";
  });
  }
  } catch (e) {
  debugPrint("Fetch Error: $e");
    setState(() {
    _isLoading = false;
    _errorMessage = "Koneksi gagal. Silahkan coba lagi.";
  });
  }
  }

    @override
    Widget build(BuildContext context) {
    return Scaffold(
  backgroundColor: const Color(0xFFF8FAFC),
  appBar: AppBar(
    title: const Text("Alkitab Digital",
      style: TextStyle(fontWeight: FontWeight.bold, fontSize: 18)),
    backgroundColor: const Color(0xFF0D47A1),
    foregroundColor: Colors.white,
    centerTitle: true,
    elevation: 0,
    actions: [
      IconButton(
      icon: const Icon(Icons.refresh),
      onPressed: _fetchBibleData,
      )
    ],
    ),
  body: _isLoading
          ? _buildLoading()
    : (_errorMessage.isNotEmpty ? _buildError() : _buildList()),
    );
  }

    Widget _buildLoading() {
    return const Center(
  child: Column(
    mainAxisAlignment: MainAxisAlignment.center,
    children: [
      CircularProgressIndicator(color: Color(0xFF0D47A1)),
      SizedBox(height: 20),
      Text("Sinkronisasi Data Alkitab...", style: TextStyle(color: Colors.blueGrey)),
    ],
    ),
    );
  }

    Widget _buildError() {
    return Center(
  child: Padding(
    padding: const EdgeInsets.all(30.0),
    child: Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        const Icon(Icons.error_outline_rounded, size: 60, color: Colors.redAccent),
        const SizedBox(height: 16),
        Text(_errorMessage, textAlign: TextAlign.center),
        const SizedBox(height: 24),
        ElevatedButton(
        onPressed: _fetchBibleData,
        style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF0D47A1), foregroundColor: Colors.white),
        child: const Text("Coba Lagi"),
        )
      ],
    ),
    ),
    );
  }

    Widget _buildList() {
    return ListView.builder(
  padding: const EdgeInsets.all(12),
  itemCount: _books.length,
  itemBuilder: (context, index) {
    final book = _books[index];

    // Pemetaan Field sesuai dengan YAML:
    // bookIndex, slug, name, maxChapter
    final String title = book['name'] ?? "Unknown Book";
    final String slug = book['slug'] ?? "";
    final String chapters = (book['maxChapter'] ?? "-").toString();
    
    return Card(
    elevation: 0,
    margin: const EdgeInsets.only(bottom: 10),
    shape: RoundedRectangleBorder(
      borderRadius: BorderRadius.circular(12),
      side: BorderSide(color: Colors.grey.shade300),
    ),
    child: ListTile(
      leading: CircleAvatar(
        backgroundColor: Colors.blue.shade50,
        child: Text("${book['bookIndex'] ?? index + 1}",
          style: TextStyle(color: Colors.blue.shade900, fontSize: 12, fontWeight: FontWeight.bold)),
      ),
      title: Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),
      subtitle: Text("ID: $slug â€¢ $chapters Pasal"),
      trailing: const Icon(Icons.chevron_right, color: Colors.grey),
      onTap: () {
        // Navigasi detail bisa dikembangkan di sini
    },
    ),
    );
  },
    );
  }
  }
